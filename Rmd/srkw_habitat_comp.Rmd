---
title: "Stock Composition in SRKW Habitat"
output: 
  pdf_document:
header-includes:
  \usepackage{float}
  \floatplacement{figure}{H}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# knitr::opts_chunk$set(fig.pos = "H", out.extra = "")

library(tidyverse)
library(stockseasonr)

source(here::here("R", "utils.R"))

rec_raw <- readRDS(here::here("data", "rec", "rec_gsi.rds")) %>% 
  janitor::clean_names() %>% 
  rename(stock_region = region) %>% 
  filter(!is.na(lat), !is.na(lon)) 

#import plot list from rkw_habitat_fit.R
plot_list <- readRDS(
  here::here("figs", "rkw_habitat", "stratified_habitat_size_effects.rds")
)

```

Here are some basic model predictions of stock composition within SRKW critical habitat based on samples collected from the recreational fishery (2014-2022). The model accounts for changes in mean stock composition among years, months, capture region (Haro, Sooke, and Swiftsure) and whether a sample was collected inside or outside SRKW foraging habitat. SRKW foraging habitat was defined based on model estimates where probability of likely foraging was greater than 0.25 and the posterior estimate was greater than 0.7 (relevant file "swiftsure.forage.0.25exc.0.7prop.poly_NAD83_BCAlbers.shp"). Note that this is a conservative estimate of foraging resulting in relatively large polygons. 

```{r clean, include=FALSE}
comp_in <- rec_raw %>% 
  filter(
    !legal == "sublegal",
    !cap_region == "outside"
  ) %>% 
  mutate(
    sample_id = paste(cap_region, week_n, rkw_habitat,
                      year, sep = "_"),
    cap_region = as.factor(cap_region)
  ) %>% 
  group_by(sample_id) %>% 
  mutate(
    nn = length(unique(id)) %>% as.numeric,
    # add abbreviated key for model fitting
    stock_group2 = tolower(stock_group) %>% 
      str_replace_all(., " ", "_") %>% 
      paste("stock", ., sep = "-")
  ) %>% 
  ungroup() %>% 
  group_by(sample_id, 
           rkw_habitat,
           cap_region, week_n, month_n, year, nn, 
           stock_group2) %>% 
  summarize(prob = sum(prob), .groups = "drop") %>% 
  filter(
    month_n >= 5 & month_n <= 9
  )

comp_in_large <- rec_raw %>% 
  filter(
    !legal == "sublegal",
    !cap_region == "outside",
    fl >= 750
  ) %>% 
  mutate(
    sample_id = paste(cap_region, week_n, rkw_habitat,
                      year, sep = "_"),
    cap_region = as.factor(cap_region)
  ) %>% 
  group_by(sample_id) %>% 
  mutate(
    nn = length(unique(id)) %>% as.numeric,
    # add abbreviated key for model fitting
    stock_group2 = tolower(stock_group) %>% 
      str_replace_all(., " ", "_") %>% 
      paste("stock", ., sep = "-")
  ) %>% 
  ungroup() %>% 
  group_by(sample_id, 
           rkw_habitat,
           cap_region, week_n, month_n, year, nn, 
           stock_group2) %>% 
  summarize(prob = sum(prob), .groups = "drop") %>% 
  filter(
    month_n >= 5 & month_n <= 9
  )

# subset predicted composition dataset
pred_dat_comp <- expand.grid(
  cap_region = unique(comp_in$cap_region),
  rkw_habitat = unique(comp_in$rkw_habitat),
  month_n = seq(min(comp_in$month_n),
                max(comp_in$month_n),
                by = 0.1)
  )
```

Geo-referenced fishing locations show that there are a relatively large number of samples collected inside and outside SRKW habitat (colours), as well as among the three regions (shapes). Note that the outside region isn't just seaward of Swiftsure, but includes all subareas that do not include SRKW habitat (e.g. near Victoria and Gulf Islands). This was an arbitrary decision and could be adjusted, for example by including these samples in Haro/Sooke or creating additional regions.

```{r fishing_locations, fig.cap="Fishing locations and associated GSI samples. Grey polygons outlined in red represent predicted SRKW foraging habtiat. Coloured polygons represent statistical subareas. Subareas and points are colored depending on whether they include (blue) or exclude (red) SRKW foraging habitat. The size of points represent the number of individuals sampled. The shape of points correspond to regions Swiftsure, Sooke, Haro, or outside (i.e. all other areas).", fig.height=3, warning=FALSE, echo=FALSE}
loc_map <- readRDS(here::here("figs", "data_coverage", "harvest_locations.rds"))
loc_map +
  theme(
    axis.title = element_blank()
  )
```

The goal of the initial analysis was to guide future model development by testing two hypotheses:

1. Does stock composition differ inside and outside SRKW habitat polygons, within a given region?
2. Does stock composition differ when smaller Chinook salmon are excluded?

To answer the first question I compared model predictions of stock composition inside and outside habitat polygons. To answer the second I fit two models, the first includes all GSI samples from legal sized Chinook (>65 or 45 cm depending on PFMA) and the second only includes samples from Chinook larger than 75 cm. After removing all samples form sublegal fish, all samples collected before May or after September, and samples outside the three regions of interest (triangles, squares, and diamonds only in above map) there were 7211 GSI samples, 3009 of which originated from fish larger than 75 cm.

The following figures show mean model predictions with confidence intervals or mean predictions with the raw data. Each point represents one observation, i.e. the stock composition of the samples collected in a single region/habitat strata, week and year. 

Generally there were minor differences between samples collected within SRKW foraging habitat (blue) and outside (red). The largest difference was relatively more Fraser Summer 4.1 and West Coast Vancouver Island samples and relatively fewer Puget Sound samples. 

```{r area_preds, fig.cap = "Mean predicted stock composition and 95% confidence intervals (ribbons). Colors represent predictions inside and outside SRKW foraging polygons within a given region.", echo=FALSE}
plot_list[[1]] +
  theme(legend.position = "top")
```


```{r area_preds_obs, fig.cap = "Mean predicted stock composition and observed stock composition. Individual points represent weekly observations with size scaled to the number of samples. Colors represent predictions inside and outside SRKW foraging polygons within a given region.", echo=FALSE}
plot_list[[2]]
```

Constraining the analysis to only include large individuals (greater than 75 cm fork length) increased the contribution of Fraser Yearling and Fraser Summer 4_1 individuals and reduced the contribution of Puget Sound fish. 

```{r size_preds_obs, fig.cap = "Mean predicted stock composition and observed stock composition. Individual points represent weekly observations with size scaled to the number of samples. Colors represent predictions with all samples (green) or with only individuals larger than 75 cm (orange).", echo=FALSE}
plot_list[[4]]
```

These patterns suggest that we should consider stratifying future analyses by habitat and body size, rather than pooling data within a spatial location or all size classes. 

Outstanding issues:

1. Temporal resolution -- do we exclude GSI samples collected from months/years without SRKW diet data?
2. Spatial resolution -- do we exclude GSI samples collected from regions where SRKW reside, but with limited spatial/diet data (e.g. northern Strait of Georgia and Fraser River mouth)?
3. How do we stratify salmon data? For example, should samples near Victoria be pooled with Haro, with Sooke or with something else?

Long-term objectives based on preliminary TOR:

1a. Rank stock groups in importance, by month, based on their relative abundance in SRKW foraging habitat.
1b. Determine whether rank importance changes if only large individuals are considered.
2. Rank stock groups in importance, by month, based on their relative abundance in SRKW diet.
3. Test for evidence of selectivity using a simulation exercise.