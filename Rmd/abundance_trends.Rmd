---
title: "Trends in Seasonal Abundance"
output: html_document
---

Here we use catch and effort data from recreational fisheries in Juan de Fuca Strait to estimate changes in total Chinook salmon abundance, while accounting for seasonal patterns. By pairing these estimates with stock composition from genetic sampling (2014-2020) we can also estimate stock-specific abundance. Similarly we can run a second set of models, which use *size* composition data from creel sampling to estimate changes in body size. To begin a few clarifications.

First, abundance is estimated assuming a fixed effort (overall mean of monthly means in all rec fisheries; ~1350 boat days) applied for each month and statistical area. Estimates for a region are then summed across all stat areas in that region (i.e. 121 and 21 here). This effectively turns fisheries dependent data into an index of abundance. The predictions shown here are generated with a model containing two components (one for abundance, one for composition (either stock or size bins)). Each models monthly changes with a seasonal smoother (analogous to LOESS), while estimating interannual variation as a random effect. Happy to discuss details further as needed.

Second, the Swiftsure foraging area corresponds to stat areas 121 and 21, while the portion of Haro that is in Canadian waters is 19B and 19C. Unfortunately stratifying GSI samples by stat area (not to mention sub-stat area) reduces the sample size to such an extent that I don't trust the model predictions (mean of <10 samples per month/year/area). For now I've estimated abundance at the stat area level for areas 121/21 and applied stock composition estimates for Juan de Fuca as a whole (defined here as areas 21, 121, 20, and the western portion of 19), the rationale being that many of the Swiftsure fish will be migrating through Juan de Fuca in the near future so stock composition should be correlated. We can do something similar for area 19 in the southern Strait of Georgia, but I'm not sure which areas should be rolled up and have held off for now. Also makes it easier to interpret figures. Note that these same issues apply to the size class data. 

Third, creel data are limited to June-September for stat areas 121 and 21 so it's not possible to estimate abundance earlier/later in the year. For the southern Strait of Georgia it will be May-September. Note that I also haven't pulled new data from Wilf's files yet, which should include 2020 and, hopfully soon, 2021. There are also options if we want to extend the stock-specific estimates back in time, but this will require additional assumptions. Basically we can generate an estimate of stock composition excluding annual effects (i.e. composition in an average year), then generate an estimate for previous years by sampling from the distribution of annual variability. These estimates will have inflated uncertainty, but be statistically defensible. 

Fourth, the stock groups I've chosen here are somewhat arbitrary. For example, Fraser early includes both threatened yearling CUs (spring/summer 4.2s and 5.2s), as well as highly abundant summer 4.1s. The stock groups can be aggregated or split as needed, though generating a large number of stocks will probably give the model some trouble (ratio of parameters to data decreases). At least for Juan de Fuca it probably makes sense to split out the different early run Fraser and pool some of the less commonly encountered stocks (e.g. Columbia, coastal BC and coastal US). Trick will be finding mix of stock groupings that is intuitive for both SoG and JdF. Again similar comments apply to the size class data.


```{r import_fits, include=FALSE}
library(tidyverse)
library(ggridges)

stock_preds <- readRDS(
  here::here("data", "model_fits", "combined_mvn_121_21_only_pred_abund.rds")
  ) %>%
  mutate(dataset = "stock") %>% 
  select(dataset, region, month_n, year, group = stock, pred_abund_est,
         pred_abund_low, pred_abund_up)
agg_preds <- readRDS(
  here::here("data", "model_fits",
             "negbin_rsmooths_121_21_only_pred_abund.rds")) %>% 
  mutate(group = "total",
         dataset = "total") %>% 
  select(dataset, region, month_n, year, group, pred_abund_est, pred_abund_low,
         pred_abund_up)
size_preds <- readRDS(
  here::here("data", "model_fits", "size",
                   "combined_mvn_121_21_only_pred_abund.rds")
) %>% 
  mutate(dataset = "size") %>% 
  # duplicated with agg_preds
  # filter(!size_bin == "total") %>% 
  select(dataset, region, month_n, year, group = size_bin, pred_abund_est,
         pred_abund_low, pred_abund_up)

# combine predictions
preds <- list(agg_preds, size_preds, stock_preds) %>% 
  bind_rows() %>% 
  mutate(
    month_f = case_when(
    month_n == "6" ~ "June",
    month_n == "7" ~ "July",
    month_n == "8" ~ "Aug",
    month_n == "9" ~ "Sep",
    TRUE ~ NA_character_
  ),
  month_f = fct_reorder(month_f, month_n)
  ) 

preds_trim <- preds %>% 
  filter(year %in% c("2014", "2015", "2016", "2017", "2018", "2019"))

# subset for plotting
stock_preds_trim <- preds_trim %>%
  filter(dataset == "stock") %>% 
  mutate(stock = fct_reorder(group, -pred_abund_est))
size_preds_trim <- preds_trim %>%
  filter(dataset == "size") %>% 
  mutate(group = fct_relevel(group, unique(group)))

write.csv(preds,
          here::here("data", "model_fits",
                     "combined_mvn_121_21_abund_preds.csv"),
          row.names = FALSE)
```

I've generated some figures to highlight seasonal and interannual patterns, first for Chinook overall (i.e. all legal sized fish, no stock composition data), followed by some stock-specific results. Apologies for not providing more interpretation, but I felt that might be better saved for finalized results or in a meeting.

The first plot shows summed total abundance on the z-axis for available months (x) and years (y). Abundance appears to have increased, particularly early in the year. There also appear to have been some changes in the phenology of the overall run. 

```{r agg_ridge, echo=FALSE}
ggplot(data = preds %>% filter(dataset == "total"),  
       aes(x = month_n, y = year, fill = year)) +
  geom_ridgeline(aes(height = pred_abund_est), alpha = 0.4, scale = 0.00015) +
  scale_fill_viridis_d() +
  labs(x = "Month", y = "Year") +
  ggsidekick::theme_sleek() +
  scale_x_continuous(expand = c(0, 0)) +
  theme(legend.position = "none")
```

These estimates can also be visualized in a faceted plot that includes estimates of uncertainty (ribbon represents 95% CI).

```{r agg_ribbon, echo=FALSE}
ggplot(data = preds %>% filter(group == "total"),  
       aes(x = month_n)) +
  geom_line(aes(y = pred_abund_est, colour = dataset)) +
  geom_ribbon(aes(ymin = pred_abund_low, ymax = pred_abund_up, fill = dataset,
                  colour = dataset),
              alpha = 0.2) +
  scale_fill_viridis_d() +
  scale_colour_viridis_d() +
  facet_wrap(~year) +
  ggsidekick::theme_sleek() +
  scale_x_continuous(expand = c(0, 0)) +
  labs(x = "Month", y = "Catch Index (All Stocks)") +
  theme(legend.position = "none")
```

The interannual trend can also be emphasized, without the seasonal smooths, as month-specific estimates (interval represents 95% CI).

```{r agg_dot, echo=FALSE}
ggplot(data = preds %>% filter(dataset == "total", !is.na(month_f)),  
       aes(x = year, y = pred_abund_est, colour = year)) +
  geom_pointrange(aes(ymin = pred_abund_low, ymax = pred_abund_up)) +
  scale_colour_viridis_d() +
  facet_wrap(~month_f) +
  ggsidekick::theme_sleek() +
  labs(x = "Year", y = "Catch Index (All Stocks)") +
  theme(legend.position = "none")
```

Slightly different patterns emerge when considering stock-specific abundance. Specifically the dominance of Fraser early run and Puget Sound fish here is apparent. Note change in color scale because fewer years available.

```{r stock_ridge, echo=FALSE}
ggplot(data = stock_preds_trim,  
       aes(x = month_n, y = year, fill = year)) +
  geom_ridgeline(aes(height = pred_abund_est), alpha = 0.4, scale = 0.00015) +
  scale_fill_viridis_d(option = "A") +
  labs(x = "Month", y = "Year") +
  ggsidekick::theme_sleek() +
  scale_x_continuous(expand = c(0, 0)) +
  facet_wrap(~stock, nrow = 1) +
  theme(legend.position = "none")
```

Again we can include estimates of uncertainty in a couple different ways. Note here that the y-axis varies among stock groups.

```{r stock_ribbon, echo=FALSE}
ggplot(data = stock_preds_trim,  
       aes(x = month_n)) +
  geom_line(aes(y = pred_abund_est)) +
  geom_ribbon(aes(ymin = pred_abund_low, ymax = pred_abund_up, fill = year), 
              col = "grey60", lty = 2, alpha = 0.2) +
  scale_fill_viridis_d(option = "A") +
  facet_grid(stock~year, scales = "free_y") +
  ggsidekick::theme_sleek() +
  scale_x_continuous(expand = c(0, 0)) +
  labs(x = "Month", y = "Catch Index") +
  theme(legend.position = "none")
```

```{r stock_dot, echo=FALSE}
ggplot(data = stock_preds_trim %>% filter(!is.na(month_f)),  
       aes(x = year, y = pred_abund_est, fill = year), shape = 21) +
  geom_pointrange(aes(ymin = pred_abund_low, ymax = pred_abund_up, fill = year),
                  shape = 21) +
  scale_fill_viridis_d(option = "A") +
  facet_grid(stock~month_f, scales = "free_y") +
  ggsidekick::theme_sleek() +
  labs(x = "Year", y = "Catch Index") +
  theme(legend.position = "none")
```


Finally we can make equivalent plots focused on size classes, rather than stocks. 

```{r size_ridge, echo=FALSE}
ggplot(data = size_preds_trim,  
       aes(x = month_n, y = year, fill = year)) +
  geom_ridgeline(aes(height = pred_abund_est), alpha = 0.4, scale = 0.00025) +
  scale_fill_viridis_d(option = "A") +
  labs(x = "Month", y = "Year") +
  ggsidekick::theme_sleek() +
  scale_x_continuous(expand = c(0, 0)) +
  facet_wrap(~group, nrow = 1) +
  theme(legend.position = "none")
```

Again we can include estimates of uncertainty in a couple different ways. Note here that the y-axis varies among stock groups.

```{r size_ribbon, echo=FALSE}
ggplot(data = size_preds_trim,  
       aes(x = month_n)) +
  geom_line(aes(y = pred_abund_est)) +
  geom_ribbon(aes(ymin = pred_abund_low, ymax = pred_abund_up, fill = year), 
              col = "grey60", lty = 2, alpha = 0.2) +
  scale_fill_viridis_d(option = "A") +
  facet_grid(group~year, scales = "free_y") +
  ggsidekick::theme_sleek() +
  scale_x_continuous(expand = c(0, 0)) +
  labs(x = "Month", y = "Catch Index") +
  theme(legend.position = "none")
```

```{r stock_dot, echo=FALSE}
ggplot(data = size_preds_trim %>% filter(!is.na(month_f)),  
       aes(x = year, y = pred_abund_est, fill = year), shape = 21) +
  geom_pointrange(aes(ymin = pred_abund_low, ymax = pred_abund_up, fill = year),
                  shape = 21) +
  scale_fill_viridis_d(option = "A") +
  facet_grid(group~month_f, scales = "free_y") +
  ggsidekick::theme_sleek() +
  labs(x = "Year", y = "Catch Index") +
  theme(legend.position = "none")
```