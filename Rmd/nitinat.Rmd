---
title: "Stock Composition and Stock-Specific Abundance Near Nitinat River Mouth"
output: 
  pdf_document:
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(stockseasonr)

comp_in_raw <- readRDS(here::here("data", "rec", "rec_gsi.rds")) 
comp_in <- comp_in_raw %>% 
  rename(stock_region = region) %>% 
  mutate(
    # define stock groups
    agg_new = case_when(
      grepl("NITINAT", stock) ~ "Nitinat",
      grepl("SWVI", resolved_stock_rollup) ~ "SWVI",
      grepl("NWVI", resolved_stock_rollup) ~ "other",
      pst_agg == "WCVI" ~ "SWVI",
      grepl("CR", pst_agg) ~ "other",
      grepl("CST", pst_agg) ~ "other",
      pst_agg == "NBC_SEAK" ~ "other",
      # grepl("Fraser", Region1Name) | pst_agg == "FR-early" ~ "Fraser",
      Region1Name %in% c("Fraser_Summer_4.1") ~ "Fraser_S",
      Region1Name %in% c("Fraser_Summer_5.2", "Fraser_Spring_5.2",
                         "Fraser_Spring_4.2") | pst_agg == "FR-early" ~
        "Fraser_Yearling",
      Region1Name %in% c("Fraser_Fall") ~ "Fraser_F",
      TRUE ~ pst_agg
    ),
    subarea_original = subarea,
    subarea = case_when(
      subarea %in% c("21A", "121C") ~ "21A-121C",
      subarea %in% c("20DO", "20D", "20C") ~ "20D-20C",
      # subarea %in% c("20A", "20E") ~ "20A-20E",
      TRUE ~ subarea
    ),
    # define core areas 
    zone = case_when(
      subarea %in% c("121A", "21A-121C") ~ "core",
      subarea %in% c("121B", "20A-20E", "20E", "20A", #"123U",
                     "123R", "20B", "20D-20C", #"20E",
                     "23J") ~ "full",
      TRUE ~ "out"
    ),
    zone = factor(zone, levels = c("core", "full", "out"))
  ) 
```

The south coast stock composition and catch/effort data are currently binned at the creel survey subarea level, which approximately correspond to PFMA subareas. The relevant Nitinat creel survey areas include 121A and 21A, as well as 121C (121A corresponds to 121-1, 21A to 21-0 and 121 C spans an inshore portion of 121-1 and 121-2). The basic framework I used was to fit a model generating predictions of a) stock-composition and b) stock-specific abundance (a function of stock composition and total abundance based on fishery catch per unit effort). This model framework has been peer reviewed (Freshwater et al. 2021).

Model predictions, rather than raw data alone, are helpful for providing information in this context because of substantial heterogeneity in sampling coverage (Figure \ref{fig:figs1}). In particular there are no composition data for May and very little for September in the subareas of interest. Therefore I fit the model using data from subareas in relatively close proximity, but generated predictions for subareas (a small number were pooled due to small sample sizes or changes in naming through time, e.g. 21A and 121C). GSI data were binned to emphasize Nitinat, southwest coast Vancouver Island and Fraser stock groups.

```{r exp_figs, echo = FALSE, fig.cap="\\label{fig:figs1}Number of GSI samples available by biweekly sampling event, year and creel survey subarea. Colors represent subareas in close proximity to Nitinat mouth (red) or in surrounding area (blue)."}
trim_stock_biweekly <- comp_in %>%
  filter(
    !legal == "sublegal",
    !zone == "out"
  ) %>% 
  mutate(
    month = lubridate::month(date, label = TRUE),
    month_n = lubridate::month(date),
    week = lubridate::week(date),
    biweek = ceiling(week / 2),
    yday = lubridate::yday(date),
    sample_id = paste(biweek, subarea, #week,
                      year, sep = "_"),
    area_f = as.factor(as.numeric(gsub("([0-9]+).*$", "\\1", area)))
  ) %>% 
  filter(month_n < 10.1 & month_n > 1.9) %>% 
  group_by(sample_id) %>% 
  mutate(nn = length(unique(id)) %>% as.numeric) %>% 
  ungroup() %>% 
  group_by(sample_id, subarea, subarea_original, area_f, reg = cap_region, 
           biweek, year, nn, agg_new, zone) %>% 
  summarize(prob = sum(prob), .groups = "drop") %>% 
  ungroup() %>% 
  mutate(
    year = as.factor(year),
    subarea = as.factor(subarea),
    agg_new = paste("stock", agg_new, sep = "-")
  ) %>% 
  droplevels() 

trim_stock_biweekly %>%
  select(sample_id, year, subarea_original, biweek, nn, zone) %>%
  distinct() %>%
  ggplot() +
  geom_jitter(aes(x = biweek, y = year, size = nn, colour = zone),
              alpha = 0.5, width = 0.25) +
  facet_wrap(~fct_reorder(subarea_original, as.numeric(as.factor(zone)))) +
  ggsidekick::theme_sleek() +
  scale_size_continuous(name = "Sample\nSize") +
  scale_fill_discrete(guide = "none") +
  labs(x = "Biweekly Sampling Period", y = "Year")
```

Both raw stock composition data (Figure \ref{fig:figs2}) and model predicted stock compositions (Figure \ref{fig:figs3}) highlight dramatic seasonal changes in relative abundance. Large contributions of Puget Sound and non-focal stocks (primarily Columbia River) dominate 121A and 21A-121C early in the year. Fraser Summer 4.1 fish (predominantly South Thompson) are relatively abundant in 121A in July and August, while SWVI and Nitinat stocks are highly abundant in 21A-121C in August and September. These reflect three distinct marine life histories:

1. Puget Sound fish are resident near Swiftsure Bank throughout the year and some portion of the population appears to migrate northwest towards La Perouse bank as they mature (hence their relative abundance declines). These populations are much more numerous than Fraser Summer 4.1 or WCVI populations so even though most of the Puget Sound aggregate is located several miles away from shore, they make up a significant portion of the fishery in nearshore areas like 21A.
2. Fraser Summer 4.1 migrate through the area during late summer. Like Puget Sound fish, they are relatively more abundant in 121A than 21A, however their migration is relatively more compressed temporally.
3. SWVI and Nitinat populations are rare until mid-August at which point they are the dominant stocks in nearshore (e.g. 21A, 123R), but not offshore areas. However their total abundance is substantially smaller than Puget Sound or Fraser Summer Run populations. 

Broadly these life histories are apparent in patterns of stock-specific abundance (Figure \ref{fig:figs4}).

```{r raw_comp, echo = FALSE, fig.cap="\\label{fig:figs2}Observed stock composition data by creel survey subarea. Numbers at base of bars represent sample sizes."}
## observed stock composition
mean_comp <- trim_stock_biweekly %>%
  group_by(subarea_original, biweek) %>% 
  mutate(total_samples = sum(prob)) %>% 
  group_by(subarea_original, zone, biweek, total_samples, agg_new) %>% 
  summarize(
    agg_prob = sum(prob),
    agg_ppn = agg_prob / total_samples,
    n_years = length(unique(year)),
    .groups = "drop"
  ) %>% 
  ungroup() %>% 
  distinct() %>% 
  mutate(
    total_years = length(unique(trim_stock_biweekly$year)),
    ppn_years = n_years /total_years,
    stock = str_split(agg_new, "-") %>% 
      purrr::map(., ~ .x[2]) %>% 
      as.character() %>% 
      c(),
    stock = factor(
      stock,
      levels = c("Nitinat", "SWVI",
                 # "Fraser",
                 "Fraser_Yearling", "Fraser_S", "Fraser_F",
                 "PSD", "SOG", "other")
    )
  )
labs <- mean_comp %>% 
  dplyr::select(biweek, subarea_original, zone, total_samples) %>% 
  distinct() 
ggplot() + 
  geom_bar(data = mean_comp, 
           aes(fill = stock, y = agg_ppn, x = biweek),
           position = "stack", stat = "identity") +
scale_fill_brewer(name = "Stock Group", palette = "Spectral") +
    labs(x = "Biweekly Sampling Period", y = "Stock Composition") +
  geom_text(data = labs, aes(x = biweek, y = -Inf, label = total_samples),
            position = position_dodge(width = 0.9), size = 2,
            vjust = -0.5) +
  facet_wrap(~fct_reorder(subarea_original, as.numeric(as.factor(zone))),
             ncol = 3) +
  ggsidekick::theme_sleek() 
```

```{r comp_model_preds, echo = FALSE, fig.cap="\\label{fig:figs3}Model predicted stock composition from May to September. Subareas outside of the immediate Nitinat area are shown for comparison, but are faded."}
# generated in nitinat_preds_composition
comb_preds <- readRDS(
        here::here(
          "data", "model_fits", "nitinat_only", "composition_preds.RDS"
        ))
alpha_pal <- c(1.0, 0.3, 0.3)
names(alpha_pal) <- unique(comb_preds$zone)

ggplot(data = comb_preds %>% 
         filter(model == "full"), 
       aes(x = month_n)) +
  geom_area(aes(y = pred_prob_est, colour = stock, fill = stock,
                alpha = zone), 
            stat = "identity") +
  scale_alpha_manual(values = alpha_pal, guide = "none") +
  scale_fill_brewer(name = "Stock Group", palette = "Spectral") +
  scale_colour_brewer(name = "Stock Group", palette = "Spectral") +
  labs(y = "Predicted Composition", x = "Month") +
  theme_classic() +
  theme(legend.position = "top",
        axis.text = element_text(size=9),
        plot.margin = unit(c(2.5, 11.5, 5.5, 5.5), "points")
  ) +
  coord_cartesian(expand = FALSE, ylim = c(0, NA)) +
  facet_wrap(~subarea)
```

```{r int_model_preds, echo = FALSE, fig.cap="\\label{fig:figs4}Model predicted stock-specific indices of abundance from June to September (representative creel data for May are not available). Note that these estimates are corrected for seasonal changes in effort and provide an index of relative abundance, not an estimate of absolute abundance. Ribbons represent 95% confidence intervals."}
# generated in nitinat_preds_composition
integrated_preds <- readRDS(
        here::here(
          "data", "model_fits", "nitinat_only", "integrated_preds.RDS"
        ))
ggplot(data = integrated_preds %>% 
         filter(model == "full", zone == "core"), 
       aes(x = month_n)) +
  labs(y = "Predicted Index of Abundance", x = "Month") +
  facet_grid(subarea~stock) +
  ggsidekick::theme_sleek() +
  geom_line(aes(y = pred_ppn_mu_est)) +
  geom_ribbon(aes(ymin = pred_ppn_mu_low, ymax = pred_ppn_mu_up),
              alpha = 0.2)
```

There is also a strong seasonal pattern in recreational fishery effort in these subareas (Figure \ref{fig:figs5}). Vessel activity peaks in July for 121A and August for 21A. As a result, the fishery in 121A is predominantly interacting with Fraser Summer 4.1, Puget Sound and Columbia River populations, while the fishery in 21A is predominantly interacting with SWVI stocks, including the local Nitinat population. Effort estimates correspond to a relatively small number of vessels per day (median = 2.1 to 4.73), though this ignores variation between weekdays and weekends.

```{r seasonal_effort, echo = FALSE, fig.cap="\\label{fig:figs5}Estimates of effort (summed vessel days per month) in Nitinat creel survey subareas. Box plots represent variability among years."}
catch_subarea_raw <- readRDS(here::here("data", "rec", "rec_creel_subarea.rds"))
catch_subarea <- catch_subarea_raw %>% 
  mutate(
    subarea = case_when(
      subarea %in% c("21A", "121C") ~ "21A-121C",
      TRUE ~ subarea
    ),
    # define core areas 
    zone = case_when(
      subarea %in% c("121A", "21A-121C") ~ "core",
      TRUE ~ "out"
    ),
    zone = factor(zone, levels = c("core", "intermediate", "full", "out")),
    # correct apparently missing effort data
    effort = ifelse(catch == "0" & is.na(effort),
                    0,
                    effort)
  ) %>%
  # remove sublegals then sum catch pooling clip rates and AD marks
  filter(
    !zone == "out",
    legal == "legal"#,
    # subarea_est == "yes"
  ) %>% 
  # first sum by original subarea to combine all catches (effort the same)
  group_by(
    month_n, year, subarea, zone, effort
  ) %>% 
  summarize(
    catch = sum(catch),
    .groups = "drop"
  ) %>% 
  # then sum by new subarea to combine catch AND effort across originally distinct
  # subareas
  group_by(
    month_n, year, subarea, zone
  ) %>% 
  summarize(
    catch = sum(catch),
    effort = sum(effort),
    cpue = catch / effort,
    offset = log(effort),
    year = as.factor(year),
    .groups = "drop"
  ) %>% 
  distinct() %>% 
  # remove 0 CPUE observations (skeptical)
  filter(
    !is.na(cpue)
  )
ggplot(catch_subarea %>% 
                            filter(subarea %in% c("121A", "21A-121C"))) +
  geom_boxplot(aes(x = as.factor(month_n), y = effort)) +
  facet_wrap(~fct_reorder(subarea, as.numeric(as.factor(zone)))) +
  ggsidekick::theme_sleek() +
  labs(
    x = "Month",
    y = "Summed Vessel Days Per Month"
  )
```

Finally there are several important caveats associated with these data and analyses. First, while the model is capable of providing estimates of total uncertainty, these require input from fisheries management on specific objectives. As a result, point estimates should be viewed as preliminary and will be most reliable for areas and months with large sample sizes. The effect of declines in sampling effort associated with fishery closures is difficult to estimate and has not been accounted for here. Second, the spatial resolution of these outputs is relatively coarse. Work is ongoing to generate down-scaled estimates of stock-specific abundance at granular scales. The results shown here should not be taken as evidence that salmon distributions (or fisher activity) are homogeneous within a creel survey subarea. 